<!DOCTYPE html>
<html lang="en">

<head>
  <meta chrset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="ico/png26.ico" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="/echarts.js"></script>

  <title>V-Labs</title>
</head>

<body>

  <style>
    body {
      font-family: "Tahoma", sans-serif;
      font-size: 10px;
      line-height: 25px;
      color: #164a44;

    }

    .brand {
      text-align: center;
    }

    .zone {
      border: 2px solid #164a44;
      height: 50px;
      margin: 10px;
    }

    .picture {
      height: 20px;
    }

    #placeholder {
      width: 450px;
      height: 200px;
    }
  </style>

  <h2 class="brand">V-LABS</h2>

  <div id="main" style="height:300px;"></div>

  <div id="output" accept=".csv" style="min-height: 200px; white-space: pre; border: 1px solid black;"
    ondragenter="document.getElementById('output').textContent = ''; event.stopPropagation(); event.preventDefault();"
    ondragover="event.stopPropagation(); event.preventDefault();" ondrop="event.stopPropagation(); event.preventDefault();
    dodrop(event);">
    DROP FILES HERE FROM FINDER OR EXPLORER



  </div>

  <input id="csvfile" type="file" name="readable" accept=".csv" />

  <div hidden id="preview"></div><!-- спрятанный элемент -->
  <div hidden id="compensated"></div><!-- спрятанный элемент -->
  <div hidden id="uncompensated"></div><!-- спрятанный элемент -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- JavaScript code -->

  <script type="text/javascript">
    let compensated = document.getElementById('compensated');
    let uncompensated = document.getElementById('uncompensated');
    var range = [];
    var sortRange = [];
    var files;

    // function output(text) {
    //   document.getElementById("output").textContent += text;
    //   //dump(text);
    //   console.log('output');
    // }

    function getCol(matrix, col) {
      var column = [];
      for (var itemRow = 1; itemRow < matrix.length - 1; itemRow++) {
        // if (col[itemRow] == "NaN") {
        //   console.log("have NaN");
        // };
        column.push(matrix[itemRow][col]);
        //console.log(col[itemRow]);
      }
      return column;
    }

    function dodrop(event) {
      let dt = event.dataTransfer;
      //console.log(dt);
      files = dt.files;
      console.log(typeof files[0].name);

      let count = files.length;
      //output("File Count: " + count + "\n");

      for (let i = 0; i < files.length; i++) {
        let reader = new FileReader();
        reader.readAsText(files[i]); //читаем файл как текст
        //console.log(reader);
        reader.onload = function () {
          var data = []; //добавляем в массив имена точек
          //console.log(reader);
          //console.log(data);
          var csv = reader.result;
          var currentFile = files[0].name
          if(RegExp(/comp/i).test(currentFile)){
            compensated.textContent = csv;
            console.log(currentFile);
          } else if (RegExp(/without/i).test(currentFile)) {
            uncompensated.textContent = csv;
            console.log(csv);
          }
          
          //console.log(compensated.textContent);
          var rows = csv.split(/\r\n|\n/); //разделяем csv файл на строки
          for (var i = 0; i < rows.length; i++) {
            var cells = rows[i].split(";").splice(
              3); //преобразоваываем каждую сторку в массив и убираем не нужные данные
            //console.log(cells);           
            data.push(cells);
          }
          //console.log('data' + data[1]);

          var points = data[0];
          var value = [];
          for (var stringMeas = 0; stringMeas < data.length; stringMeas++) {
            var curentGetCol = getCol(data, stringMeas);
            let minValue = Math.min.apply(null, curentGetCol.filter(function(n) { return !isNaN(n); }));
            //console.log(minValue);
            let maxValue = Math.max.apply(null, curentGetCol.filter(function(n) { return !isNaN(n); }));
            //console.log(maxValue);
            let currentCalc = (maxValue - minValue);
            //console.log(currentCalc);
            value.push(currentCalc.toFixed(2));
          }



          for (var item = 0; item < data[0].length; item++) { //data[0] колличество точек
            var limit = 0.15;
            range.push(points[item]);
            range[item] = [];
            range[item].push(Number(value[item]));
            //console.log(Number(value[item]));
            range[item].push(points[item]);
            range[item].push(limit);

          }
          range.sort(RecordSort);

          function RecordSort(a, b) {
            if (a[0] < b[0]) return 1;
            else if (a[0] > b[0]) return -1;
            else return 0;
          }
          for (var i = 0; i < range.length; i++)
            sortRange.push(range[i]);
          //console.log(sortRange);
          var
            option = {
              dataset: [{
                id: 'dataset_raw',
                dimensions: ['valueRange', 'namePoint', 'limit'],
                source: sortRange
              }, ],
              title: {
                text: 'V-LAB'
              },
              tooltip: {
                trigger: 'axis'
              },
              legend: {
                data: ['uncompensated', 'compensated']
              },
              xAxis: {
                type: 'category',
                nameLocation: 'middle',
              },
              yAxis: {
                name: 'value'
              },
              series: [{
                  name: 'uncompensated',
                  type: 'bar',
                  showSymbol: false,
                  encode: {
                    x: 'namePoint',
                    y: 'valueRange'
                  }
                }, {
                  name: 'compensated',
                  type: 'bar',
                  showSymbol: false,
                  encode: {
                    x: 'namePoint',
                    y: 'valueRange'
                  }
                },
                {
                  encode: {
                    x: 'namePoint',
                    y: 'limit'
                  },
                  type: 'line',
                  color: 'red',
                  showSymbol: false
                }
              ]
            };

          option && myChart.setOption(option);
        }
        reader.onerror = function () {
          console.log(reader.error);
        }

      }
    };


    var app = {};

    var chartDom = document.getElementById('main');
    var myChart = echarts.init(chartDom);
    var option;

    var posList = [
      'left', 'right', 'top', 'bottom',
      'inside',
      'insideTop', 'insideLeft', 'insideRight', 'insideBottom',
      'insideTopLeft', 'insideTopRight', 'insideBottomLeft', 'insideBottomRight'
    ];

    app.configParameters = {
      rotate: {
        min: -90,
        max: 90
      },
      align: {
        options: {
          left: 'left',
          center: 'center',
          right: 'right'
        }
      },
      verticalAlign: {
        options: {
          top: 'top',
          middle: 'middle',
          bottom: 'bottom'
        }
      },
      position: {
        options: posList.reduce(function (map, pos) {
          map[pos] = pos;
          return map;
        }, {})
      },
      distance: {
        min: 0,
        max: 100
      }
    };

    app.config = {
      rotate: 90,
      align: 'left',
      verticalAlign: 'middle',
      position: 'bottom',
      distance: 100,
      onChange: function () {
        var labelOption = {
          normal: {
            rotate: app.config.rotate,
            align: app.config.align,
            verticalAlign: app.config.verticalAlign,
            position: app.config.position,
            distance: app.config.distance
          }
        };
        myChart.setOption({
          series: [{
            label: labelOption
          }, {
            label: labelOption
          }, {
            label: labelOption
          }, {
            label: labelOption
          }]
        });
      }
    };


    var labelOption = {
      show: true,
      position: app.config.position,
      distance: app.config.distance,
      align: app.config.align,
      verticalAlign: app.config.verticalAlign,
      rotate: app.config.rotate,
      formatter: '{c}  {name|{a}}',
      fontSize: 11,
      rich: {
        name: {}
      }
    };

    option = {

      xAxis: {
        type: 'category',
        axisLabel: {
          interval: 0,
          rotate: 90
        },
      },
      yAxis: {},
      series: {},
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'shadow'
        }
      },
      series: {
        type: 'bar'
      },
      legend: {
        data: ['V-LABS']
      },
      toolbox: {
        show: true,
        orient: 'vertical',
        left: 'right',
        top: 'center',
        feature: {
          mark: {
            show: true
          },
          dataView: {
            show: true,
            readOnly: false
          },
          magicType: {
            show: true,
            type: ['line', 'bar', 'stack', 'tiled']
          },
          restore: {
            show: true
          },
          saveAsImage: {
            show: true
          }
        }
      },
      dataZoom: [{
          type: 'slider',
          show: true,
          xAxisIndex: [0],
          start: 0,
          end: 25
        },
        {
          type: 'slider',
          show: false,
          yAxisIndex: [0],
          left: '1%',
          start: 0,
          end: 100
        },
        {
          type: 'inside',
          xAxisIndex: [0],
          start: 1,
          end: 1
        },
        {
          type: 'inside',
          yAxisIndex: [0],
          start: 1,
          end: 1
        }
      ]

    };

    option && myChart.setOption(option);
  </script>

  <script>
    // Элемент для выбора файлов.
    const INPUT = document.querySelector('input[name="readable"]');
    // Элемент для вывода сгенерированной таблицы.
    const PREVIEW = document.querySelector('#preview');
    // Регулярное выражение для проверки расширения файла.
    const REGEX = new RegExp('(.*?)\.(csv)$', 'i');

    // Функция, отрабатывающая при выборе файла.
    function handleFile(event) {
      // Выбираем первый файл из списка файлов.
      const file = event.target.files[0];

      // Если файл выбран и его расширение допустимо,
      // то читаем его содержимое и отправляем
      // в функцию отрисовки таблицы.
      if (file && REGEX.test(file.name)) {
        // Создаем экземпляр объекта.
        const reader = new FileReader();

        // Чтение файла асинхронное, поэтому
        // создание таблицы привязываем к событию `load`,
        // которое срабатывает при успешном завершении операции чтения.
        reader.onload = (e) => renderTable(e.target.result);

        // Читаем содержимое как текстовый файл.
        reader.readAsText(file);
      } else {
        // Мизерная обработка ошибок.
        alert('Файл не выбран либо его формат не поддерживается.');
        event.target.value = '';
      }
    }

    // Функция отрисовки таблицы.
    function renderTable(data) {
      // Предварительно создадим элементы,
      // отвечающие за каркас таблицы.
      let table = document.createElement('table');
      let thead = document.createElement('thead');
      let tbody = document.createElement('tbody');

      // Добавим класс к таблице.
      table.classList.add('table');

      // Разбиваем входящие данные построчно.
      // Разделитель - перенос строки.
      // Перебираем полученный массив строк.
      data.split(/\r\n|\r|\n/)
        .forEach(function (row, index) {
          // Создадим элемент строки для таблицы.
          let trow = document.createElement('tr');

          // Разбиваем каждую строку на ячейку.
          // Разделитель - точка с запятой.
          // Перебираем полученный массив будущих ячеек.
          row.split(/;/).forEach(function (cell) {
            // Создадим элемент ячейки для таблицы.
            let tcell = document.createElement(index > 0 ? 'td' : 'th');
            // Заполним содержимое ячейки.
            tcell.textContent = cell;
            // Добавляем ячейку к родительской строке.
            trow.appendChild(tcell);
          });

          // Добавляем строку к родительскому элементу.
          // Если индекс строки больше нуля,
          // то родительский элемент - `tbody`,
          // в противном случае- `thead`.
          index > 0 ? tbody.appendChild(trow) : thead.appendChild(trow);
        });

      // Добавляем заголовок таблицы к родительскому элементу.
      table.appendChild(thead);
      // Добавляем тело таблицы к родительскому элементу.
      table.appendChild(tbody);

      // Очищаем элемент для вывода таблицы.
      PREVIEW.innerHTML = '';
      // Добавляем саму таблицу к родительскому элементу.
      PREVIEW.appendChild(table);
    }

    // Регистрируем функцию обработчика события `change`,
    // срабатывающего при изменении элемента выбора файла.
    INPUT.addEventListener('change', handleFile);
  </script>


</body>

</html>