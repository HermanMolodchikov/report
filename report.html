<!DOCTYPE html>
<html>

<head>
  <meta chrset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/svg-editor-image.svg" />
  <script src="/echarts.js"></script>
  <title>V-Labs</title>
</head>

<body id="output" accept=".csv" style="height: 1000px;" event.stopPropagation(); event.preventDefault();"
  ondragover="event.stopPropagation(); event.preventDefault();" ondrop="event.stopPropagation(); event.preventDefault();
dodrop(event);">

  <div id="svgwrap" class="container">
    <img
src="data:image/gif;base64,R0lGODdhMAAwAPAAAAAAAP///ywAAAAAMAAw
AAAC8IyPqcvt3wCcDkiLc7C0qwyGHhSWpjQu5yqmCYsapyuvUUlvONmOZtfzgFz
ByTB10QgxOR0TqBQejhRNzOfkVJ+5YiUqrXF5Y5lKh/DeuNcP5yLWGsEbtLiOSp
a/TPg7JpJHxyendzWTBfX0cxOnKPjgBzi4diinWGdkF8kjdfnycQZXZeYGejmJl
ZeGl9i2icVqaNVailT6F5iJ90m6mvuTS4OK05M0vDk0Q4XUtwvKOzrcd3iq9uis
F81M1OIcR7lEewwcLp7tuNNkM3uNna3F2JQFo97Vriy/Xl4/f1cf5VWzXyym7PH
hhx4dbgYKAAA7"
height="16px" width="16px" alt="какая-то картинка" />
   <img src="/image3.svg" alt="">
    <a id="todownloadComp">Download compensation</a>
    <a id="todownloadUmcomp">Donwload uncompansation</a>
  </div>
  <h2 id="nameTest"></h2>
  
  <div class="open-popup container">
    <table style="border: 2px solid #000;">
      <tbody>
        <tr>
          <td>Vendor</td>
          <td></td>
        </tr>
        <tr>
          <td>Type</td>
          <td></td>
        </tr>
        <tr>
          <td>Location</td>
          <td></td>
          </td>
        </tr>
        <tr>
          <td>Project</td>
          <td></td>
        </tr>
      </tbody>
    </table>
    <table style="border: 2px solid #000;">
      <tbody>
        <tr>
          <td>Station</td>
          <td></td>
        </tr>
        <tr>
          <td>Measurement plan</td>
          <td></td>
        </tr>
        <tr>
          <td>Production Number </td>
          <td></td>
          </td>
        </tr>
        <tr>
          <td>Test date</td>
          <td></td>
        </tr>
      </tbody>
    </table>
    <table style="border: 2px solid #000;">
      <tbody>
        <tr style="font-weight: 900; border-bottom: 4px solid #000;">
          <td>Test specification</td>
          <td></td>
        </tr>
        <tr>
          <td>Acceptance criteria</td>
          <td>Max Deviation is 0.25</td>
        </tr>
        <tr>
          <td>Mismeasurements</td>
          <td></td>
        </tr>
        <tr>
          <td>No measurement directions</td>
          <td></td>
        </tr>
      </tbody>
    </table>
    <table style="border: 2px solid #000;">
      <tbody>
        <tr style="font-weight: 900; border-bottom: 4px solid #000;">
          <td>Test results</td>
          <td>Status</td>
        </tr>
        <tr>
          <td>qwe</td>
          <td> </td>
        </tr>
        <tr>
          <td>qwe</td>
          <td> </td>
        </tr>
        <tr>
          <td>qwe</td>
          <td> </td>
        </tr>
      </tbody>
    </table>
    <table style="margin-left: auto;">
      <tbody>
        <tr>
          <td></td>
        </tr>
        <tr>
          <td style="font-weight: 900;">Test result statistics</td>
          <td>0</td>
        </tr>
        <tr>
          <td>Deviation Min</td>
          <td>3.56</td>
        </tr>
        <tr>
          <td>Deviation Average</td>
          <td>0.12</td>
        </tr>
        <tr>
          <td>Directions count</td>
          <td>390</td>
        </tr>
      </tbody>
    </table>
  </div>


  <div class="popup__bg">
    <form id="formElem" class="popup">
      <p class="close-popup">x</p>
      <label>
        <input type="text" name="Vendor" placeholder="VILAB LLC">
        <div class="label__text">
          Vendor
        </div>
      </label>
      <label>
        <input type="text" name="Type" placeholder="Inline">
        <div class="label__text">
          Type
        </div>
      </label>
      <label>
        <input type="text" name="Location" placeholder="Germany Leipzig"></input>
        <div class="label__text">
          Location
        </div>
      </label>
      <label>
        <input type="text" name="Project" placeholder="Porsche PO426">
        <div class="label__text">
          Vendor
        </div>
      </label>
      <label>
        <input type="Type" name="Type" placeholder="VILAB LLC">
        <div class="label__text">
          Station
        </div>
      </label>
      <label>
        <input name="Location" placeholder="VILAB LLC"></input>
        <div class="label__text">
          Measurement plan
        </div>
      </label>
      <label>
        <input type="text" name="Vendor" placeholder="VILAB LLC">
        <div class="label__text">
          Production Number
        </div>
      </label>
      <label>
        <input type="text" name="Type" placeholder="VILAB LLC">
        <div class="label__text">
          Test date
        </div>
      </label>
      <label>
        <input name="text" placeholder="X Y Z"></input>
        <div class="label__text">
          Controlled directions
        </div>
      </label>
      <label>
        <input name="text" placeholder="Max Deviation is 0.25"></input>
        <div class="label__text">
          Acceptance criteria
        </div>
      </label>
      <label>
        <input name="text" placeholder="0"></input>
        <div class="label__text">
          Mismeasurements
        </div>
      </label>
      <label>
        <input name="text" placeholder="0"></input>
        <div class="label__text">
          No measurement directions
        </div>
      </label>
      <button type="submit">Отправить</button>
    </form>
  </div>

  <div id="main" style="height:500px; width: 100%;">
  </div>

  <input id="csvfile" type="file" name="readable" accept=".csv" />

  <div id="preview"></div><!-- спрятанный элемент -->
  <div hidden id="compensated"></div><!-- спрятанный элемент -->
  <div hidden id="uncompensated"></div><!-- спрятанный элемент -->

  <style>
    body {
      font-family: "Tahoma", sans-serif;
      height: 842px;
      width: 800px;
      margin-left: auto;
      margin-right: auto;
      font-size: 12px;
      line-height: 25px;
      color: #000;
      background-color: #fff;
      padding: 10px;
      text-decoration: none;
    }

    @media print {

      html,
      body {
        height: 297mm;
        width: 210mm;
      }

      a[href]:after {
        content: none !important;
      }
    }

    th,
    td {
      padding: 2px;
      line-height: 1.2;
      max-width: 50px;
    }

    .container {
      display: -webkit-flex;
      -webkit-justify-content: flex-start;
      display: flex;
      justify-content: flex-start;
      -webkit-flex-wrap: wrap;
      flex-wrap: wrap;
    }

    table {
      width: 50%;
      border-spacing: 0px;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    table:hover {
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }

    svg {
      padding: 10px;

    }

    #svgwrap {
      padding-right: 20px;
    }

    #placeholder {
      width: 450px;
      height: 200px;
    }

    #preview {
      font-size: 9px;
      margin: 2px;
    }

    /*pop-up*/
    .popup__bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: 0.5s all;
      z-index: 4;
    }

    .popup__bg.active {
      opacity: 1;
      pointer-events: all;
      transition: 0.5s all;
    }

    .popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: #fff;
      width: 300px;
      padding: 10px;
      transition: 0.5s all;
      border-radius: 5px;
    }

    .popup.active {
      transform: translate(-50%, -50%) scale(1);
      transition: 0.5s all;
    }

    /* Конец важной части */
    /* Далее код для стилизации формы */
    .close-popup {
      position: absolute;
      top: -20px;
      right: 10px;
      cursor: pointer;
      font-size: 20px;
    }

    .close-popup:hover {
      color: rgb(255, 0, 51);
    }

    .popup label {
      width: 100%;
      margin-bottom: 1px;
      display: flex;
      flex-direction: column-reverse;
    }

    .popup .label__text {
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 900;
      color: #999;
      margin-bottom: -2px;
    }

    .popup input {
      height: 10px;
      font-size: 12px;
      border: none;
      outline: none;
      border-bottom: 1px solid #cfd0d3;
    }

    .popup input:focus {
      border-bottom: 1px solid #2982ff;
    }

    .popup input:focus+.label__text {
      color: #2982ff;
    }

    .popup textarea {
      resize: none;
      width: 100%;
      height: 75px;
      border: none;
      outline: none;
      border-bottom: 1px solid #cfd0d3;
      font-size: 12px;
      padding-top: 5px;
    }

    .popup textarea:focus {
      border-bottom: 1px solid #2982ff;
    }

    .popup textarea:focus+.label__text {
      color: #2982ff;
    }

    button {
      margin-top: 15px;
      width: 100%;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 18px;
      border: 2px solid #030303;
      background: #696969;
      cursor: pointer;
      text-transform: uppercase;
      transition: 0.5s all;
      border-radius: 5px;
    }

    a {
      margin: 10px auto;
      width: 200px;
      height: 25;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 12px;
      border: 2px solid #030303;
      background: #696969;
      cursor: pointer;
      text-transform: uppercase;
      transition: 0.5s all;
      border-radius: 5px;
      padding: 5px;
    }

    a:hover,
    button:hover {
      background: #fff;
      color: #888585;
      transition: 0.5s all;
      text-decoration: none;
    }
    a:active, a:link, a:visited {
      text-decoration: none;
    }

  </style>
  <script>
    //Download file
    document.getElementById('todownloadComp').onclick = function () {
      let text = compensated.textContent;
      let myData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(text);
      this.href = myData;
      this.download = 'compensaited.csv';
    }
    document.getElementById('todownloadUmcomp').onclick = function () {
      let text = uncompensated.textContent;
      let myData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(text);
      this.href = myData;
      this.download = 'without.csv';
    }

    //POPUP
    let popupBg = document.querySelector('.popup__bg'); // Фон попап окна
    let popup = document.querySelector('.popup'); // Само окно
    let openPopupButtons = document.querySelectorAll('.open-popup'); // Кнопки для показа окна
    let closePopupButton = document.querySelector('.close-popup'); // Кнопка для скрытия окна
    openPopupButtons.forEach((button) => { // Перебираем все кнопки
      button.addEventListener('click', (e) => { // Для каждой вешаем обработчик событий на клик
        e.preventDefault(); // Предотвращаем дефолтное поведение браузера
        popupBg.classList.add('active'); // Добавляем класс 'active' для фона
        popup.classList.add('active'); // И для самого окна
      })
    });

    closePopupButton.addEventListener('click', () => { // Вешаем обработчик на крестик
      popupBg.classList.remove('active'); // Убираем активный класс с фона
      popup.classList.remove('active'); // И с окна
    });

    document.addEventListener('click', (e) => { // Вешаем обработчик на весь документ
      if (e.target === popupBg) { // Если цель клика - фот, то:
        popupBg.classList.remove('active'); // Убираем активный класс с фона
        popup.classList.remove('active'); // И с окна
      }
    });

    /*GET SEND form*/
    formElem.onsubmit = async (e) => {
      e.preventDefault();

      let response = await fetch('/article/formdata/post/user', {
        method: 'POST',
        body: new FormData(formElem)
      });

      let result = await response.json();

      alert(result.message);
    };
  </script>

  <script type="text/javascript">
    let compensated = document.getElementById('compensated');
    let uncompensated = document.getElementById('uncompensated');
    var range = [];
    var sortRange = [];
    var compensatedRange = [];
    var files;
    // }

    window.onload = function () {
      if (RegExp(/Measurement/i).test(compensated.textContent) || RegExp(/Measurement/i).test(uncompensated
          .textContent)) {
        readFromHere(compensated.textContent, uncompensated.textContent);
      }
    };

    function readFromHere(comp, uncomp) {
      var data = []; //добавляем в массив имена точек
      var data2 = []; //добавляем в массив имена точек
      writeInArray(uncomp, data, range);
      //console.log();
      range.sort(RecordSort);
      for (var i = 0; i < range.length; i++) {
        sortRange.push(range[i]);
      }
      writeInArray(comp, data2, compensatedRange);
      //compensatedRange.sort(RecordSort);
      console.log(data);
      for (let i = 0; i < sortRange.length; i++) {
        for (let j = 0; j < compensatedRange.length; j++) {
          if (compensatedRange[j][1] === sortRange[i][1]) {
            sortRange[i].push(compensatedRange[j][
              0
            ]); //добаляем откомпенсированый значения в отсортированный массив
          }
        }
      }
      option && myChart.setOption(option);
      //console.log(comp);
      //console.log(comp);
    }

    function getCol(matrix, col) {
      var column = [];
      for (var itemRow = 1; itemRow < matrix.length - 1; itemRow++) {
        // if (col[itemRow] == "NaN") {
        //   console.log("have NaN");
        // };
        column.push(matrix[itemRow][col]);
        //console.log(col[itemRow]);
      }
      return column;
    }

    function writeInArray(csv, data, pushToArr) {
      var rows = csv.split(/\r\n|\n/); //разделяем csv файл на строки
      for (var i = 0; i < rows.length; i++) {
        if (rows[i] == '') continue;
        var cells = rows[i].split(";").splice(
          3
        ); //преобразоваываем каждую сторку в массив и убираем не нужны первые три значения номер модели, дата, план
        data.push(cells);
      }
      var points = data[0];
      var value = [];
      for (var stringMeas = 0; stringMeas < points.length; stringMeas++) {
        var curentGetCol = getCol(data, stringMeas);
        let minValue = Math.min.apply(null, curentGetCol.filter(function (n) {
          return !isNaN(n);
        }));
        let maxValue = Math.max.apply(null, curentGetCol.filter(function (n) {
          return !isNaN(n);
        }));
        let currentCalc = (maxValue - minValue);
        value.push(currentCalc.toFixed(2));
      }
      for (var item = 0; item < data[0]
        .length; item++
      ) { //data[0] колличество точек. Перебираем по длине вложеного первого массива . то есть по колличеству точек
        var limit = 0.15;
        pushToArr.push(points[item]);
        pushToArr[item] = []; //добавление вложеного массива
        pushToArr[item].push(Number(value[item])); //пушим в текущщий массив вычесленной значение рэнджа
        pushToArr[item].push(points[item]) // пушим название точек после каждого соответсвующего значения
        pushToArr[item].push(limit); //пушим в каждую точку лимит
      }
    };

    function RecordSort(a, b) { //функция для сортировки массива по убыванию 
      if (a[0] < b[0]) return 1;
      else if (a[0] > b[0]) return -1;
      else return 0;
    }

    function dodrop(event) {
      let dt = event.dataTransfer;
      //console.log(dt);
      let files = dt.files;
      console.log(files);
      let count = files.length;
      //output("File Count: " + count + "\n");
      for (let i = 0; i < files.length; i++) {
        let reader = new FileReader();
        reader.readAsText(files[i]); //читаем файл как текст
        //reader.readAsBinaryString(files[i]);
        //console.log(files[i].name);
        var currentFile = files[i].name;
        console.log(currentFile);
        reader.onload = function () {
          var data = []; //добавляем в массив имена точек
          var data2 = []; //добавляем в массив имена точек
          //console.log(reader);
          //console.log(data);
          var csv = reader.result;
          if (RegExp(/without/i).test(currentFile)) {
            data = [];
            uncompensated.textContent = null;
            compensated.textContent = null;
            uncompensated.textContent = csv;
            writeInArray(csv, data, range);
            //console.log(uncompensated.textcontent);
            //console.log(data);
            //console.log(currentFile);
            range.sort(RecordSort); // сортируем массив по первым значениям вложеных массивов
            for (var i = 0; i < range.length; i++) {
              sortRange.push(range[i]); // запушиваем отсортированые значения в масиив
            }
          }
          console.log(sortRange);
          if (RegExp(/comp/i).test(currentFile)) {
            compensated.textContent = csv;
            writeInArray(csv, data2, compensatedRange);
            //compensatedRange.sort(RecordSort);
            //console.log(csv);
            // if( sortRange.length !== compensatedRange.length) {
            //   alert ("Разное колличество дирекшинов!!!");
            // }
            for (let i = 0; i < sortRange.length; i++) { // перебираемпо длине отсортированного массива 
              for (let j = 0; j < compensatedRange.length; j++) { //перебираем по длине откомпенсированого массива
                if (compensatedRange[j][1] === sortRange[i][1]) {
                  sortRange[i].push(compensatedRange[j][
                    0
                  ]); //добаляем откомпенсированый значения в отсортированный массив
                }
              }
            }
          }
          reader.onerror = function () {
            console.log(reader.error);
          }
          if (files.length == 1) {
            option && myChart.setOption(option);
          }
        }
      }
      //console.log(sortRange); 
    };

    var app = {};

    var chartDom = document.getElementById('main');
    var myChart = echarts.init(chartDom);
    var option;

    var posList = [
      'left', 'right', 'top', 'bottom',
      'inside',
      'insideTop', 'insideLeft', 'insideRight', 'insideBottom',
      'insideTopLeft', 'insideTopRight', 'insideBottomLeft', 'insideBottomRight'
    ];

    app.configParameters = {
      rotate: {
        min: -90,
        max: 90
      },
      align: {
        options: {
          left: 'left',
          center: 'center',
          right: 'right'
        }
      },
      verticalAlign: {
        options: {
          top: 'top',
          middle: 'middle',
          bottom: 'bottom'
        }
      },
      position: {
        options: posList.reduce(function (map, pos) {
          map[pos] = pos;
          return map;
        }, {})
      },
      distance: {
        min: 0,
        max: 100
      }
    };

    app.config = {
      rotate: 90,
      align: 'left',
      verticalAlign: 'middle',
      position: 'bottom',
      distance: 100,
      onChange: function () {
        var labelOption = {
          normal: {
            rotate: app.config.rotate,
            align: app.config.align,
            verticalAlign: app.config.verticalAlign,
            position: app.config.position,
            distance: app.config.distance
          }
        };
        myChart.setOption({
          series: [{
            label: labelOption
          }, {
            label: labelOption
          }, {
            label: labelOption
          }, {
            label: labelOption
          }]
        });
      }
    };


    var labelOption = {
      show: true,
      position: app.config.position,
      distance: app.config.distance,
      align: app.config.align,
      verticalAlign: app.config.verticalAlign,
      rotate: app.config.rotate,
      formatter: '{c}  {name|{a}}',
      fontSize: 11,
      rich: {
        name: {}
      }
    };

    option = {
      dataset: [{
        id: 'dataset_raw',
        dimensions: ['valueRange', 'namePoint', 'limit', 'valueCompensated'],
        source: sortRange
      }, ],
      title: {
        text: ''
      },
      tooltip: {
        trigger: 'axis'
      },
      legend: {
        data: ['uncompensated', 'compensated']
      },
      xAxis: {
        type: 'category',
        nameLocation: 'middle',
        axisLabel: {
          interval: 0,
          rotate: 90
        },
      },
      yAxis: {},
      series: {},
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'shadow'
        }
      },
      series: [{
          name: 'uncompensated',
          type: 'bar',
          showSymbol: false,
          encode: {
            x: 'namePoint',
            y: 'valueRange'
          }
        }, {
          name: 'compensated',
          type: 'bar',
          showSymbol: false,
          encode: {
            x: 'namePoint',
            y: 'valueCompensated'
          }
        },
        {
          encode: {
            x: 'namePoint',
            y: 'limit'
          },
          type: 'line',
          color: 'red',
          showSymbol: false
        }
      ],
      toolbox: {
        show: true,
        orient: 'vertical',
        left: 'right',
        top: 'center',
        feature: {
          mark: {
            show: false
          },
          dataView: {
            show: false,
            readOnly: false
          },
          magicType: {
            show: false,
            type: ['line', 'bar', 'stack', 'tiled']
          },
          restore: {
            show: false
          },
          saveAsImage: {
            show: false
          }
        }
      },
      grid: {
        bottom: 200,
      },
      dataZoom: [{
        type: 'slider',
        show: true,
        xAxisIndex: [0],
        start: 0,
        end: 25
      }]

    };
    option && myChart.setOption(option);
  </script>

  <script>
    // Элемент для выбора файлов.
    const INPUT = document.querySelector('input[name="readable"]');
    // Элемент для вывода сгенерированной таблицы.
    const PREVIEW = document.querySelector('#preview');
    // Регулярное выражение для проверки расширения файла.
    const REGEX = new RegExp('(.*?)\.(csv)$', 'i');

    // Функция, отрабатывающая при выборе файла.
    function handleFile(event) {
      // Выбираем первый файл из списка файлов.
      const file = event.target.files[0];

      // Если файл выбран и его расширение допустимо,
      // то читаем его содержимое и отправляем
      // в функцию отрисовки таблицы.
      if (file && REGEX.test(file.name)) {
        // Создаем экземпляр объекта.
        const reader = new FileReader();

        // Чтение файла асинхронное, поэтому
        // создание таблицы привязываем к событию `load`,
        // которое срабатывает при успешном завершении операции чтения.
        reader.onload = (e) => renderTable(e.target.result);

        // Читаем содержимое как текстовый файл.
        reader.readAsText(file);
      } else {
        // Мизерная обработка ошибок.
        alert('Файл не выбран либо его формат не поддерживается.');
        event.target.value = '';
      }
    }

    // Функция отрисовки таблицы.
    function renderTable(data) {
      // Предварительно создадим элементы,
      // отвечающие за каркас таблицы.
      let table = document.createElement('table');
      let thead = document.createElement('thead');
      let tbody = document.createElement('tbody');

      // Добавим класс к таблице.
      table.classList.add('table');

      // Разбиваем входящие данные построчно.
      // Разделитель - перенос строки.
      // Перебираем полученный массив строк.
      data.split(/\r\n|\r|\n/)
        .forEach(function (row, index) {
          // Создадим элемент строки для таблицы.
          let trow = document.createElement('tr');

          // Разбиваем каждую строку на ячейку.
          // Разделитель - точка с запятой.
          // Перебираем полученный массив будущих ячеек.
          row.split(/;/).forEach(function (cell) {
            // Создадим элемент ячейки для таблицы.
            let tcell = document.createElement(index > 0 ? 'td' : 'th');
            // Заполним содержимое ячейки.
            tcell.textContent = cell;
            // Добавляем ячейку к родительской строке.
            trow.appendChild(tcell);
          });

          // Добавляем строку к родительскому элементу.
          // Если индекс строки больше нуля,
          // то родительский элемент - `tbody`,
          // в противном случае- `thead`.
          index > 0 ? tbody.appendChild(trow) : thead.appendChild(trow);
        });

      // Добавляем заголовок таблицы к родительскому элементу.
      table.appendChild(thead);
      // Добавляем тело таблицы к родительскому элементу.
      table.appendChild(tbody);

      // Очищаем элемент для вывода таблицы.
      PREVIEW.innerHTML = '';
      // Добавляем саму таблицу к родительскому элементу.
      PREVIEW.appendChild(table);
    }

    // Регистрируем функцию обработчика события `change`,
    // срабатывающего при изменении элемента выбора файла.
    INPUT.addEventListener('change', handleFile);
  </script>

</body>

</html>